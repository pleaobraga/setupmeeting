<!DOCTYPE html>
<html ng-app="meeting">
<head>

  <title>Set Up a Meeting</title>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <base href="/" />

  <link rel="stylesheet" href="node_modules/angular-material/angular-material.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
  rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic">
  <link rel="stylesheet" type="text/css" href="styles/app.css">


  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPbTIwcRFCxFIALB4ayDB96lEA6wpJK-U&libraries=places"></script>


  <script src="node_modules/angular/angular.min.js"></script>
  <script src="node_modules/angular-route/angular-route.min.js"></script>
  <script src="node_modules/angular-resource/angular-resource.min.js"></script>
  <script src="node_modules/angular-aria/angular-aria.min.js"></script>
  <script src="node_modules/angular-animate/angular-animate.min.js"></script>
  <script src="node_modules/angular-messages/angular-messages.min.js"></script>
  <script src="node_modules/angular-sanitize/angular-sanitize.min.js"></script>
  <script src="node_modules/angular-material/angular-material.min.js"></script>

  <script>
  var meeting = angular.module("meeting",['ngRoute','ngResource','ngAria','ngAnimate','ngMessages','ngSanitize','ngMaterial']);

  //Formate date dd/mm/yyyy
  meeting.config(function($mdDateLocaleProvider)
  {
    $mdDateLocaleProvider.formatDate = function(date)
    {
      //if date was setted
      if(!(angular.isUndefined(date) && date == null))
      {
        //get date proprieties
        var day = date.getDate();
        var monthIndex = date.getMonth() + 1;
        var year = date.getFullYear();

        //add 0 to day string
        if(day < 10)
        {
          day = '0' + day;
        }

        //add 0 to month string
        if(monthIndex < 10)
        {
          monthIndex = '0' + monthIndex;
        }

        //return correct date formate
        return day + '/' + monthIndex  + '/' + year;

      }
      //return if date was not setted
      else
      {
        return '';

      }
    };
});

meeting.factory('timeZoneService', ['$resource', function($resource)
{
  return $resource('https://maps.googleapis.com/maps/api/timezone/json?location=:lat,:lng&timestamp=:time&key=AIzaSyAPbTIwcRFCxFIALB4ayDB96lEA6wpJK-U',
  {lat: '@lat', lng: '@lng', time: '@time'},
  {
    getTimeZone : {method: 'get'}
  });


}]);

  meeting.controller("meetingCtrl", ['$scope', 'timeZoneService', function($scope, timeZoneService){

    //select the iputs to add autocomplete by google api
    var input = document.getElementById('yourCity');
    var input2 = document.getElementById('theirCity')

    //insert into inputs google api autocomplete
    var autocomplete1 = new google.maps.places.Autocomplete(input, { types: ['(cities)']});
    var autocomplete2 = new google.maps.places.Autocomplete(input2, { types: ['(cities)']});

    $scope.cities = [{name: '', lat: '', lng: '', timeZone: ''},{name: '', lat: '', lng: '', timeZone: ''}];

    google.maps.event.addListener(autocomplete1, 'place_changed', function ()
    {
      var place =  autocomplete1.getPlace()
       $scope.cities[0].lat = place.geometry.location.lat();
       $scope.cities[0].lng = place.geometry.location.lng();
       $scope.cities[0].name = place.formatted_address;
       $scope.getTimeZone($scope.cities[0]);
    });

    google.maps.event.addListener(autocomplete2, 'place_changed', function ()
    {
      var place =  autocomplete2.getPlace()
       $scope.cities[1].lat = place.geometry.location.lat();
       $scope.cities[1].lng = place.geometry.location.lng();
       $scope.cities[1].name = place.formatted_address;
       $scope.getTimeZone($scope.cities[1]);
    });

    $scope.$watch('cities',
      function()
      {
        if($scope.cities[0].timeZone != '' &&  $scope.cities[1].timeZone != '')
        {
          $scope.citiesSorted = angular.copy($scope.cities);

          $scope.citiesSorted.sort(function(a,b){return a.timeZone-b.timeZone});

          if($scope.citiesSorted[1].timeZone - $scope.citiesSorted[0].timeZone <= 8)
          {
            $scope.citiesSorted[0].hour = '9:00 AM';

            if($scope.citiesSorted[1].timeZone > 0 &&  $scope.citiesSorted[0].timeZone < 0)
            {
                $scope.citiesSorted[1].hour = 9 + $scope.citiesSorted[1].timeZone - $scope.citiesSorted[0].timeZone - 1;
            }
            else
            {
              $scope.citiesSorted[1].hour = 9 + $scope.citiesSorted[1].timeZone - $scope.citiesSorted[0].timeZone;
            }

            if($scope.citiesSorted[1].hour >= 12)
            {
              $scope.citiesSorted[1].hour = ($scope.citiesSorted[1].hour - 12) + ':00 PM';

            }
            else
            {
              $scope.citiesSorted[1].hour += ':00 AM';

            }

            $scope.meeting = true;

            return;
          }

          $scope.meeting  = 'timeExceeded';
        }
      },  true);






    $scope.getTimeZone = function(city)
    {
      var year =  $scope.dateMeeting.getFullYear();
      var day = $scope.dateMeeting.getDate();
      var month =  $scope.dateMeeting.getMonth() + 1;


      var time = Math.floor(new Date(year,month,day,9,0).getTime()/1000);

      timeZoneService.getTimeZone({lat:city.lat, lng: city.lng, time: time},
      function(response)
      {
        city.timeZone = (response.dstOffset + response.rawOffset)/3600;

        console.log(response);

      },
      function(response)
      {
        city.timeZone = '';

        console.log(response);

      });
    };
  }]);

  </script>

</head>
<body ng-controller="meetingCtrl">

  <md-content>
    <md-whiteframe class="md-whiteframe-12dp" layout="column" layout-align="center start">

      <span class="md-display-2" layout="row" layout-align="start center">Marcador de Reunião Internacional</span>

      <md-divider></md-divider>

      <form name="meetingForm" layout="row" layout-align="space-between center" layout-fill>
        <md-input-container flex="25">
          <label>Data da reunião</label>
          <md-datepicker  ng-model="dateMeeting" md-placeholder="Escolha a data" name="dateMeetingForm"></md-datepicker>
        </md-input-container>

        <md-input-container  >
          <label>Sua cidade</label>
          <input  id="yourCity" type="text" name="yourCityForm" placeholder="Digite a localização"/>
        </div>

        </md-input-container>

        <md-input-container>
          <label>Cidade da outra pessoa</label>
          <input  id="theirCity" type="text"  placeholder="Digite a localização"  />
        </md-input-container>

      </form>


      <span ng-show="meeting==true" class="md-headline" layout="row">Horário da reunião</span>

      <div layout="column" class="meetingInfo" ng-show="meeting==true">
        <div ng-repeat="city in citiesSorted" layout="row" layout-align="none center">
          <span style="color: #727272" class="md-body-2">{{city.name}} &nbsp - &nbsp </span>
          <span class="md-body-1">{{dateMeeting | date: 'dd/MM/yyyy'}}</span>
          <span class="md-body-2">{{city.hour}}</span>
        </div>
      </div>

      <div layout="column" ng-show="meeting=='timeExceeded'" class="md-subhead time-exceeded">
       A Reunião não poderá ocorrer pois a diferença de horario entre as cidades ultrapassa o horario comercial
     </div>

    </md-whiteframe>

  </md-content>

</body>

</html>
